<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>GeoTap</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Telegram WebApp -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Babel for transforming JSX in browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Leaflet JS (Global L) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
      /* Custom tweaks */
      * { -webkit-tap-highlight-color: transparent; }
      body { background-color: #f3f4f6; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
      #root { width: 100%; height: 100%; }
      .leaflet-container { width: 100%; height: 100%; z-index: 1; background: #e5e7eb; }
      .custom-pin-marker { transition: transform 0.1s; }
      
      .loader {
        border: 3px solid #e5e7eb;
        border-radius: 50%;
        border-top: 3px solid #2563eb;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      
      .fade-in { animation: fadeIn 0.3s ease-in; }
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
      
      .animate-slide-down { animation: slideDown 0.2s ease-out; }
      @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
    
    <!-- Import Map: Fixed to strictly use React 18.3.1 -->
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.3.1",
    "react-dom/client": "https://esm.sh/react-dom@18.3.1/client",
    "react-dom": "https://esm.sh/react-dom@18.3.1",
    "lucide-react": "https://esm.sh/lucide-react@0.469.0?deps=react@18.3.1",
    "leaflet": "https://esm.sh/leaflet@1.9.4",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel" data-type="module" data-presets="react,typescript">
      import React, { useState, useEffect, useRef, useMemo } from 'react';
      import { createRoot } from 'react-dom/client';
      import * as L from 'leaflet';
      import { 
        Phone, User as UserIcon, Trash2, Plus, Loader2, Save, 
        Package, Clock, MessageSquare, Search, MapPin, 
        CheckCircle, ChevronDown, LogOut, RefreshCw, Pencil, 
        Lock, ExternalLink, Navigation, X, ShieldAlert, AlertTriangle, 
        ExternalLink as LinkIcon, Smartphone, Globe, Settings
      } from 'lucide-react';

      // =======================================================
      // –í–ê–ñ–ù–û: –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –í–ê–® GOOGLE APPS SCRIPT URL
      // =======================================================
      const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzYOUR_SCRIPT_ID/exec';
      
      // =======================================================
      // UTILS (–≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
      // =======================================================
      function deg2rad(deg) { return deg * (Math.PI / 180); }

      function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
        const R = 6371; 
        const dLat = deg2rad(lat2 - lat1);
        const dLon = deg2rad(lon2 - lon1);
        const a =
          Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
          Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
      }

      const parseCoord = (val) => {
        if (!val) return null;
        if (typeof val === 'number') return val;
        const str = String(val).replace(',', '.');
        const num = parseFloat(str);
        return isNaN(num) ? null : num;
      };

      const getBrowserLocation = (callback) => {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (pos) => callback({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
            () => callback(null),
            { enableHighAccuracy: true, timeout: 10000 }
          );
        } else {
          callback(null);
        }
      };

      const getNativeLocation = (callback) => {
        if (window.Telegram?.WebApp?.LocationManager?.isInited) {
          window.Telegram.WebApp.LocationManager.getLocation((data) => {
            if (data && data.latitude) {
              callback({ lat: data.latitude, lng: data.longitude });
            } else {
              getBrowserLocation(callback);
            }
          });
          return;
        }
        getBrowserLocation(callback);
      };

      const formatDate = (iso) => {
        if (!iso) return "";
        const d = new Date(iso);
        if (isNaN(d.getTime())) return iso;
        return d.toLocaleDateString('ru-RU') + " " + d.toTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
      };

      // Device ID generator
      const getDeviceId = () => {
        let deviceId = localStorage.getItem('geo_bot_device_id');
        if (!deviceId) {
          deviceId = 'dev_' + Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
          localStorage.setItem('geo_bot_device_id', deviceId);
        }
        return deviceId;
      };

      // =======================================================
      // TELEGRAM DATA FUNCTIONS (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
      // =======================================================
      const detectPlatform = () => {
        const tg = window.Telegram?.WebApp;
        if (!tg) return { type: 'unknown', details: 'Telegram WebApp –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω' };
        
        const platform = tg.platform || 'unknown';
        const version = tg.version || 'unknown';
        const isWebApp = tg.initDataUnsafe && Object.keys(tg.initDataUnsafe).length > 0;
        
        return {
          type: platform,
          version: version,
          isValidWebApp: isWebApp,
          hasUserData: !!tg.initDataUnsafe?.user,
          details: {
            platform: platform,
            version: version,
            isExpanded: tg.isExpanded,
            colorScheme: tg.colorScheme,
            hasInitDataUnsafe: !!tg.initDataUnsafe,
            hasUser: !!tg.initDataUnsafe?.user,
            userData: tg.initDataUnsafe?.user
          }
        };
      };

      const getTelegramData = () => {
        return new Promise((resolve) => {
          let attempts = 0;
          const maxAttempts = 30;
          const debugLog = [];
          
          const logDebug = (message) => {
            debugLog.push(`${new Date().toLocaleTimeString()}: ${message}`);
            console.log(`[Telegram WebApp Debug] ${message}`);
          };

          logDebug("üîç –ù–∞—á–∏–Ω–∞–µ–º –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É Telegram WebApp...");
          
          // –ü–ï–†–í–´–ú –î–ï–õ–û–ú - –æ–ø—Ä–µ–¥–µ–ª–∏–º —Ç–∏–ø –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
          const platformInfo = detectPlatform();
          logDebug("üì± –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ:");
          logDebug(`   –¢–∏–ø: ${platformInfo.type}`);
          logDebug(`   –í–µ—Ä—Å–∏—è: ${platformInfo.version}`);
          logDebug(`   –í–∞–ª–∏–¥–Ω—ã–π WebApp: ${platformInfo.isValidWebApp}`);
          logDebug(`   –ï—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${platformInfo.hasUserData}`);
          
          // –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ Telegram WebApp, —Å—Ä–∞–∑—É —Å–æ–æ–±—â–∏–º
          if (!platformInfo.isValidWebApp) {
            logDebug("‚ùå –ù–ï –Ø–í–õ–Ø–ï–¢–°–Ø Telegram WebApp!");
            logDebug("   üîç –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:");
            logDebug("   1. –°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –Ω–µ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞");
            logDebug("   2. –ë–æ—Ç –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∫–∞–∫ WebApp");
            logDebug("   3. –°—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è Telegram");
            
            resolve({ 
              success: false, 
              error: "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞", 
              platformInfo: platformInfo,
              debug: debugLog,
              solution: "–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –±–æ—Ç–∞ –≤ Telegram, –∞ –Ω–µ –∫–∞–∫ –æ–±—ã—á–Ω—É—é –≤–µ–±-—Å—Ç—Ä–∞–Ω–∏—Ü—É"
            });
            return;
          }
          
          const tryGetData = () => {
            attempts++;
            logDebug(`üîÑ –ü–æ–ø—ã—Ç–∫–∞ ${attempts}/${maxAttempts}`);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
            const tg = window.Telegram?.WebApp;
            if (tg?.initDataUnsafe?.user) {
              const user = tg.initDataUnsafe.user;
              logDebug("‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω –≤ initDataUnsafe!");
              logDebug(`   ID: ${user.id}`);
              logDebug(`   Username: ${user.username || '–Ω–µ —É–∫–∞–∑–∞–Ω'}`);
              logDebug(`   –ò–º—è: ${user.first_name || ''} ${user.last_name || ''}`);
              
              const result = {
                id: user.id,
                username: user.username,
                first_name: user.first_name,
                last_name: user.last_name,
                language_code: user.language_code,
                raw: user
              };
              
              resolve({ success: true, data: result, debug: debugLog });
              return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º initData
            if (tg?.initData) {
              try {
                const params = new URLSearchParams(tg.initData);
                const userParam = params.get('user');
                if (userParam) {
                  const userData = JSON.parse(decodeURIComponent(userParam));
                  logDebug("‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω –≤ initData!");
                  
                  const result = {
                    id: userData.id,
                    username: userData.username,
                    first_name: userData.first_name,
                    last_name: userData.last_name,
                    language_code: userData.language_code,
                    raw: userData
                  };
                  
                  resolve({ success: true, data: result, debug: debugLog });
                  return;
                }
              } catch (e) {
                logDebug(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ initData: ${e.message}`);
              }
            }
            
            // –ï—Å–ª–∏ –∏—Å—á–µ—Ä–ø–∞–ª–∏ –ø–æ–ø—ã—Ç–∫–∏
            if (attempts >= maxAttempts) {
              logDebug(`‚è∞ –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ ${maxAttempts} –ø–æ–ø—ã—Ç–æ–∫`);
              resolve({ 
                success: false, 
                error: "Telegram WebApp –¥–∞–Ω–Ω—ã–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ—Å–ª–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏", 
                debug: debugLog,
                platformInfo: platformInfo
              });
              return;
            }
            
            // –ü–æ–≤—Ç–æ—Ä—è–µ–º —á–µ—Ä–µ–∑ 200ms
            setTimeout(tryGetData, 200);
          };
          
          // –ù–∞—á–∏–Ω–∞–µ–º –ø–æ–ø—ã—Ç–∫–∏
          tryGetData();
        });
      };

      // =======================================================
      // GOOGLE APPS SCRIPT API SERVICE (–ò–ó–ú–ï–ù–ï–ù–û)
      // =======================================================
      class GoogleScriptService {
        constructor(url) {
          this.baseUrl = url;
        }

        async makeRequest(functionName, params = {}) {
          try {
            const url = new URL(this.baseUrl);
            url.searchParams.append('function', functionName);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
            Object.keys(params).forEach(key => {
              url.searchParams.append(key, params[key]);
            });

            console.log(`[API] –í—ã–∑–æ–≤ ${functionName}:`, params);
            
            const response = await fetch(url.toString(), {
              method: 'GET',
              headers: {
                'Content-Type': 'application/json',
              },
            });

            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const text = await response.text();
            console.log(`[API] –û—Ç–≤–µ—Ç –æ—Ç ${functionName}:`, text);
            
            // –ü–æ–ø—ã—Ç–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON
            try {
              return JSON.parse(text);
            } catch (e) {
              console.warn(`[API] –û—Ç–≤–µ—Ç –Ω–µ JSON:`, text);
              return text;
            }
          } catch (error) {
            console.error(`[API] –û—à–∏–±–∫–∞ –≤—ã–∑–æ–≤–∞ ${functionName}:`, error);
            throw error;
          }
        }

        getAppData(telegramId, deviceId) {
          return this.makeRequest('getAppData', { telegramId, deviceId });
        }

        getGroupBrands(groupName) {
          return this.makeRequest('getGroupBrands', { groupName });
        }

        getLastStockData(user, client) {
          return this.makeRequest('getLastStockData', { 
            userInfoJson: JSON.stringify(user), 
            clientInfoJson: JSON.stringify(client) 
          });
        }

        saveStockData(stockItems, comment, user, client) {
          return this.makeRequest('saveStockData', { 
            stockDataJson: JSON.stringify(stockItems), 
            comment, 
            userInfoJson: JSON.stringify(user), 
            clientInfoJson: JSON.stringify(client) 
          });
        }

        saveContacts(rowIndex, contacts, comment, username) {
          return this.makeRequest('saveContacts', { 
            rowIndex, 
            contactsJson: JSON.stringify(contacts), 
            comment, 
            username 
          });
        }

        updateLocation(rowIndex, lat, lng, username) {
          return this.makeRequest('updateLocation', { rowIndex, lat, lng, username });
        }

        logSessionEvent(user, actionType) {
          return this.makeRequest('logSessionEvent', { 
            userJson: JSON.stringify(user), 
            actionType 
          });
        }
      }

      // –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä —Å–µ—Ä–≤–∏—Å–∞
      const googleService = new GoogleScriptService(GOOGLE_SCRIPT_URL);

      // =======================================================
      // MOCKS (–¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ - –º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ)
      // =======================================================
      const MOCK_USER = { id: '112233', name: 'Dev Agent', group: 'MIRA' };
      const MOCK_CLIENTS = [
        { rowIndex: 100, region: '–¢–∞—à–∫–µ–Ω—Ç', district: '–ú–∏—Ä–∑–æ-Ulugbek', clientName: 'Demo Market', branch: 'Branch 1', lat: "", lng: "", updatedAt: "", updatedBy: "", isLocked: false, contacts: [], inn: "111222333", comment: "" },
        { rowIndex: 101, region: '–¢–∞—à–∫–µ–Ω—Ç', district: 'Chilanzar', clientName: 'Super Store', branch: '', lat: 41.2858, lng: 69.2040, updatedAt: new Date().toISOString(), updatedBy: "Admin", isLocked: true, contacts: [{ name: "Manager", phone: "+998 90 123 45 67" }], inn: "999888777", comment: "Test record" }
      ];
      const MOCK_BRANDS = ["CocaCola", "Fanta", "Sprite", "Water 1L", "Water 5L"];

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è, —Ä–∞–±–æ—Ç–∞–µ–º –ª–∏ –º—ã –≤ —Å—Ä–µ–¥–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
      const isDevelopmentMode = () => {
        // –í —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –º–æ–∫ –¥–∞–Ω–Ω—ã–µ
        return window.location.hostname === 'localhost' || 
               window.location.hostname === '127.0.0.1' ||
               GOOGLE_SCRIPT_URL.includes('YOUR_SCRIPT_ID');
      };

      // =======================================================
      // COMPONENTS (–≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
      // =======================================================

      // 1. Contacts Modal (–æ—Å—Ç–∞–ª—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
      const ContactsModal = ({ isOpen, onClose, initialContacts, initialComment, onSave, isLocked }) => {
        const [contacts, setContacts] = useState([]);
        const [comment, setComment] = useState("");
        const [saving, setSaving] = useState(false);
        const [initialCount, setInitialCount] = useState(0);

        useEffect(() => {
          if (isOpen) {
            const list = initialContacts || [];
            setContacts(JSON.parse(JSON.stringify(list)));
            setComment(initialComment || "");
            setInitialCount(list.length);
          }
        }, [isOpen, initialContacts, initialComment]);

        const addContact = () => {
          if (contacts.length < 4) setContacts([...contacts, { name: "", phone: "+998 " }]);
        };

        const removeContact = (idx) => {
          setContacts(contacts.filter((_, i) => i !== idx));
        };

        const updateContact = (idx, field, val) => {
          const newC = [...contacts];
          if (field === 'phone') {
            let digits = val.replace(/\D/g, '');
            if (!digits.startsWith('998')) {
              if (digits.length < 3) digits = "998";
            }
            digits = digits.substring(0, 12);
            let formatted = "+998";
            if (digits.length > 3) formatted += " " + digits.substring(3, 5);
            if (digits.length > 5) formatted += " " + digits.substring(5, 8);
            if (digits.length > 8) formatted += " " + digits.substring(8, 10);
            if (digits.length > 10) formatted += " " + digits.substring(10, 12);
            newC[idx][field] = formatted;
          } else {
            newC[idx][field] = val;
          }
          setContacts(newC);
        };

        const handleSave = () => {
          setSaving(true);
          onSave(contacts, comment, () => {
            setSaving(false);
            onClose();
          });
        };

        if (!isOpen) return null;

        return (
          <div className="fixed inset-0 z-[1000] bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm fade-in">
            <div className="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
              <div className="p-4 bg-gray-50 border-b flex justify-between items-center">
                <h3 className="font-bold text-xl text-gray-800">–ö–æ–Ω—Ç–∞–∫—Ç—ã</h3>
                <button onClick={onClose} className="bg-gray-200 p-1.5 rounded-full text-gray-500 hover:bg-gray-300 transition-colors">
                  <X className="w-5 h-5" />
                </button>
              </div>

              <div className="p-4 overflow-y-auto flex-1 space-y-6 bg-gray-50/50">
                {isLocked && initialCount > 0 && (
                  <div className="flex items-start gap-2 text-xs bg-yellow-50 text-yellow-800 p-3 rounded-lg border border-yellow-200 shadow-sm">
                    <span className="text-lg">üîí</span>
                    <span className="pt-0.5">–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –∑–∞–ø—Ä–µ—â–µ–Ω–æ –∞–¥–º–∏–Ω–æ–º. –í—ã –º–æ–∂–µ—Ç–µ —Ç–æ–ª—å–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ.</span>
                  </div>
                )}

                {contacts.map((c, i) => {
                  const isProtected = isLocked && i < initialCount;
                  return (
                    <div key={i} className={`relative p-4 rounded-xl border shadow-sm transition-all ${isProtected ? 'bg-gray-100 border-gray-200 opacity-90' : 'bg-white border-blue-100 ring-1 ring-blue-50'}`}>
                      <div className="flex justify-between items-center mb-2">
                        <span className="text-xs font-bold uppercase tracking-wider text-gray-400">–ü—Ä–æ–¥–∞–≤–µ—Ü #{i + 1}</span>
                        {!isProtected && (
                          <button onClick={() => removeContact(i)} className="text-red-400 hover:text-red-600 p-1">
                            <Trash2 size={18} />
                          </button>
                        )}
                      </div>
                      <div className="space-y-3">
                        <div>
                          <label className="block text-xs font-bold text-gray-500 mb-1 ml-1 flex items-center gap-1">
                            <UserIcon size={14} /> –ò–º—è
                          </label>
                          <input
                            type="text"
                            placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø—Ä–æ–¥–∞–≤—Ü–∞"
                            value={c.name}
                            onChange={e => updateContact(i, 'name', e.target.value)}
                            disabled={isProtected}
                            className={`w-full h-12 text-base border-2 rounded-lg px-3 outline-none transition-colors ${isProtected ? 'bg-gray-100 text-gray-500 border-gray-200' : 'bg-white border-gray-200 focus:border-blue-500 text-gray-800'}`}
                          />
                        </div>
                        <div>
                          <label className="block text-xs font-bold text-gray-500 mb-1 ml-1 flex items-center gap-1">
                            <Phone size={14} /> –¢–µ–ª–µ—Ñ–æ–Ω
                          </label>
                          <input
                            type="tel"
                            placeholder="+998 90 123 45 67"
                            value={c.phone || "+998 "}
                            onChange={e => updateContact(i, 'phone', e.target.value)}
                            disabled={isProtected}
                            className={`w-full h-12 text-lg font-mono tracking-wide border-2 rounded-lg px-3 outline-none transition-colors ${isProtected ? 'bg-gray-100 text-gray-500 border-gray-200' : 'bg-white border-gray-200 focus:border-blue-500 text-gray-800'}`}
                          />
                        </div>
                      </div>
                    </div>
                  );
                })}

                <button
                  onClick={addContact}
                  disabled={contacts.length >= 4}
                  className={`w-full py-4 border-2 border-dashed rounded-xl text-sm font-bold flex items-center justify-center gap-2 transition-all ${contacts.length >= 4 ? 'border-gray-200 bg-gray-50 text-gray-400 cursor-not-allowed' : 'border-blue-300 text-blue-600 hover:bg-blue-50 active:scale-95'}`}
                >
                  {contacts.length >= 4 ? <span>–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç (4 –ø—Ä–æ–¥–∞–≤—Ü–∞)</span> : <><Plus size={18} /> –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥–∞–≤—Ü–∞</>}
                </button>

                <div className="pt-2">
                  <label className="block text-xs font-bold text-gray-500 mb-1 ml-1">üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ / –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                  <textarea
                    value={comment}
                    onChange={(e) => setComment(e.target.value)}
                    placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –í—Ö–æ–¥ —Å–æ –¥–≤–æ—Ä–∞, —Å–ø—Ä–æ—Å–∏—Ç—å –±—É—Ö–≥–∞–ª—Ç–µ—Ä–∞..."
                    className="w-full h-24 border-2 border-gray-200 rounded-xl p-3 text-sm focus:border-blue-500 outline-none resize-none"
                  />
                </div>
              </div>
              <div className="p-4 border-t bg-white shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
                <button
                  onClick={handleSave}
                  disabled={saving}
                  className="w-full bg-blue-600 text-white font-bold text-lg py-3.5 rounded-xl flex justify-center items-center gap-2 active:scale-95 transition-transform disabled:opacity-70 disabled:scale-100 shadow-lg shadow-blue-200"
                >
                  {saving ? <Loader2 className="animate-spin" /> : <><Save size={20} /> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç—ã</>}
                </button>
              </div>
            </div>
          </div>
        );
      };

      // 2. Stock Modal (–æ—Å—Ç–∞–ª—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
      const StockModal = ({ isOpen, onClose, onSave, brands, lastStockData, clientName }) => {
        const [stockValues, setStockValues] = useState({});
        const [comment, setComment] = useState("");
        const [saving, setSaving] = useState(false);

        useEffect(() => {
          if (isOpen) {
            setStockValues({});
            setComment("");
          }
        }, [isOpen]);

        const handleQtyChange = (brandName, val) => {
          setStockValues(prev => ({ ...prev, [brandName]: val }));
        };

        const handleSave = () => {
          const hasData = Object.values(stockValues).some(v => v !== "" && v !== undefined);
          if (!hasData && !comment) {
            alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –ø–æ–ª–µ");
            return;
          }
          setSaving(true);
          onSave(stockValues, comment, () => {
            setSaving(false);
            onClose();
          });
        };

        const formattedDate = useMemo(() => {
          if (!lastStockData?.date) return '';
          return formatDate(lastStockData.date);
        }, [lastStockData]);

        if (!isOpen) return null;

        return (
          <div className="fixed inset-0 z-[1000] bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm fade-in">
            <div className="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
              <div className="p-4 bg-purple-600 text-white border-b border-purple-700 flex justify-between items-center">
                <div className="flex flex-col">
                  <div className="flex items-center gap-2">
                    <Package size={20} />
                    <h3 className="font-bold text-lg">–û—Å—Ç–∞—Ç–∫–∏</h3>
                  </div>
                  <div className="text-xs text-purple-200 mt-1 max-w-[200px] truncate">{clientName}</div>
                </div>
                <button onClick={onClose} className="bg-white/20 p-1.5 rounded-full text-white hover:bg-white/30 transition-colors">
                  <X className="w-5 h-5" />
                </button>
              </div>

              <div className="p-4 overflow-y-auto flex-1 space-y-4 bg-gray-50">
                {lastStockData && lastStockData.date && (
                  <div className="bg-blue-50 border border-blue-100 p-3 rounded-lg flex items-center gap-3 text-sm text-blue-900">
                    <Clock size={20} className="text-blue-500" />
                    <div>
                      <div className="font-bold">–ü–æ—Å–ª–µ–¥–Ω—è—è –∑–∞–ø–∏—Å—å: {formattedDate}</div>
                      <div className="text-xs opacity-70">–ê–≤—Ç–æ—Ä: {lastStockData.agent}</div>
                    </div>
                  </div>
                )}

                {(!brands || brands.length === 0) ? (
                  <div className="text-center py-8 text-gray-500">
                    –ù–µ—Ç —Å–ø–∏—Å–∫–∞ –±—Ä–µ–Ω–¥–æ–≤ –¥–ª—è –≤–∞—à–µ–π –≥—Ä—É–ø–ø—ã.
                  </div>
                ) : (
                  <div>
                    <div className="grid grid-cols-[1fr_50px_50px_70px] gap-2 px-2 mb-2 text-xs font-bold text-gray-400 uppercase tracking-wider">
                      <span>–ë—Ä–µ–Ω–¥</span>
                      <span className="text-center text-[10px]">–ü—Ä–∏—Ö–æ–¥</span>
                      <span className="text-center">–ë—ã–ª–æ</span>
                      <span className="text-center">–°—Ç–∞–ª–æ</span>
                    </div>
                    {brands.map((brand, idx) => {
                      const oldVal = lastStockData?.stocks?.[brand] || "-";
                      const arrivalVal = lastStockData?.arrivals?.[brand] || "-";
                      return (
                        <div key={idx} className="grid grid-cols-[1fr_50px_50px_70px] gap-2 items-center bg-white p-2 rounded-lg border border-gray-100 shadow-sm mb-2">
                          <div className="font-bold text-gray-800 text-sm leading-tight">
                            {brand}
                          </div>
                          <div className="flex items-center justify-center h-10 bg-gray-100 rounded text-gray-500 font-medium text-xs select-none border border-gray-200">
                             {arrivalVal}
                          </div>
                          <div className="flex items-center justify-center h-10 bg-gray-50 rounded text-gray-400 font-medium text-sm select-none">
                            {oldVal}
                          </div>
                          <div>
                            <input
                              type="number"
                              placeholder=""
                              value={stockValues[brand] || ""}
                              onChange={e => handleQtyChange(brand, e.target.value)}
                              className="w-full h-10 border-2 border-purple-100 bg-white rounded-lg text-lg font-bold text-purple-900 outline-none focus:border-purple-500 text-center focus:ring-2 focus:ring-purple-200 transition-all"
                            />
                          </div>
                        </div>
                      );
                    })}
                  </div>
                )}

                <div className="pt-2">
                  <label className="block text-xs font-bold text-gray-500 mb-1 ml-1 flex items-center gap-1">
                    <MessageSquare size={16} /> –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –æ—Å—Ç–∞—Ç–∫–∞–º
                  </label>
                  <textarea
                    value={comment}
                    onChange={(e) => setComment(e.target.value)}
                    placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."
                    className="w-full h-20 border-2 border-gray-200 rounded-xl p-3 text-sm focus:border-purple-500 outline-none resize-none bg-white"
                  />
                </div>
              </div>

              <div className="p-4 border-t bg-white shadow-[0_-4px_10px_rgba(0,0,0,0.05)]">
                <button onClick={handleSave} disabled={saving || (!brands || brands.length === 0)} className="w-full bg-purple-600 text-white font-bold text-lg py-3 rounded-xl flex justify-center items-center gap-2 active:scale-95 transition-transform disabled:opacity-70 shadow-lg shadow-purple-200">
                  {saving ? <Loader2 className="animate-spin" /> : <><Save size={20} /> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</>}
                </button>
              </div>
            </div>
          </div>
        );
      };

      // 3. Map Viewer (–æ—Å—Ç–∞–ª—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
      const MapViewer = ({ anchorLat, anchorLng, markerLat, markerLng, isLocked, onLocate, onMarkerChange, isGpsLoading }) => {
        const mapContainerRef = useRef(null);
        const mapInstanceRef = useRef(null);
        const markerLayerRef = useRef(null);
        const circleLayerRef = useRef(null);

        useEffect(() => {
          if (!mapContainerRef.current || mapInstanceRef.current) return;
          
          const map = L.map(mapContainerRef.current, {
            center: [41.311, 69.240],
            zoom: 18,
            zoomControl: false,
            attributionControl: false
          });
          
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 20 }).addTo(map);
          mapInstanceRef.current = map;

          const resizeObserver = new ResizeObserver(() => { map.invalidateSize(); });
          resizeObserver.observe(mapContainerRef.current);

          return () => {
            resizeObserver.disconnect();
            map.remove();
            mapInstanceRef.current = null;
          };
        }, []);

        useEffect(() => {
          const map = mapInstanceRef.current;
          if (!map) return;

          if (anchorLat && anchorLng && !isLocked) {
            if (!circleLayerRef.current) {
              circleLayerRef.current = L.circle([anchorLat, anchorLng], {
                radius: 20,
                color: '#3b82f6',
                fillColor: '#3b82f6',
                fillOpacity: 0.1,
                weight: 1,
                dashArray: '5, 5',
                interactive: false
              }).addTo(map);
            } else {
              circleLayerRef.current.setLatLng([anchorLat, anchorLng]);
            }
          } else {
            if (circleLayerRef.current) {
              circleLayerRef.current.remove();
              circleLayerRef.current = null;
            }
          }

          if (markerLat && markerLng) {
            const isRed = !isLocked;
            const color = isRed ? '#ef4444' : '#16a34a';
            const pinHtml = `<div style="background-color: ${color}; width: 36px; height: 36px; border-radius: 50% 50% 50% 0; border: 3px solid white; box-shadow: 0 4px 8px rgba(0,0,0,0.3); transform: rotate(-45deg); display: flex; align-items: center; justify-content: center;"><div style="width: 8px; height: 8px; border-radius: 50%; background: white; transform: rotate(45deg);"></div></div>`;
            const pinIcon = L.divIcon({ className: 'custom-pin-marker', html: pinHtml, iconSize: [36, 36], iconAnchor: [18, 36] });

            const isDraggable = !isLocked && !!anchorLat && !!anchorLng;

            if (!markerLayerRef.current) {
              const marker = L.marker([markerLat, markerLng], { icon: pinIcon, draggable: isDraggable, zIndexOffset: 1000 }).addTo(map);

              marker.on('dragend', function (event) {
                const m = event.target;
                const position = m.getLatLng();

                if (!circleLayerRef.current) {
                  alert("‚ùå –û—à–∏–±–∫–∞ GPS: –ù–µ—Ç –ø—Ä–∏–≤—è–∑–∫–∏ –∫ –º–µ—Å—Ç–Ω–æ—Å—Ç–∏. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –ø—Ä–∏—Ü–µ–ª–∞.");
                  return;
                }

                const center = circleLayerRef.current.getLatLng();
                if (map.distance(center, position) > 20) {
                  m.setLatLng(center);
                  onMarkerChange(center.lat, center.lng);
                } else {
                  onMarkerChange(position.lat, position.lng);
                }
              });

              markerLayerRef.current = marker;
              map.setView([markerLat, markerLng], 18);
            } else {
              const marker = markerLayerRef.current;
              const curPos = marker.getLatLng();
              if (Math.abs(curPos.lat - markerLat) > 0.000001 || Math.abs(curPos.lng - markerLng) > 0.000001) {
                marker.setLatLng([markerLat, markerLng]);
                map.panTo([markerLat, markerLng]);
              }
              marker.setIcon(pinIcon);

              if (isDraggable) marker.dragging.enable(); else marker.dragging.disable();
            }
          } else {
            if (markerLayerRef.current) {
              markerLayerRef.current.remove();
              markerLayerRef.current = null;
            }
          }
        }, [anchorLat, anchorLng, markerLat, markerLng, isLocked, onMarkerChange]);

        return (
          <div className="relative h-full w-full">
            <div ref={mapContainerRef} className="h-full w-full bg-gray-100" />
            {!isLocked && anchorLat && (
              <div className="absolute top-2 left-2 right-2 z-[400] bg-white/95 backdrop-blur px-3 py-2 rounded-lg shadow text-xs text-center text-gray-700 pointer-events-none">
                <span className="font-bold text-red-500">–ú–∞—Ä–∫–µ—Ä –ø–æ–¥–≤–∏–∂–µ–Ω</span> (—Ä–∞–¥–∏—É—Å 20–º)
              </div>
            )}
            {isGpsLoading && !anchorLat && (
              <div className="absolute top-4 left-4 right-4 bg-white/90 backdrop-blur p-3 rounded-lg text-sm font-bold text-center shadow-lg text-blue-600 z-[500] animate-pulse">
                üì° –ò—â–µ–º —Å–ø—É—Ç–Ω–∏–∫–∏...
              </div>
            )}
            <button
              onClick={(e) => { e.stopPropagation(); onLocate(); }}
              className="absolute bottom-6 right-6 z-[400] bg-white w-14 h-14 rounded-2xl shadow-xl flex items-center justify-center text-blue-600 hover:text-blue-700 active:scale-95 transition-all border border-gray-100"
              title="–ú–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ"
            >
              <Navigation className="w-8 h-8 text-blue-600" />
            </button>
          </div>
        );
      };

      // 4. List Components (–æ—Å—Ç–∞–ª–∏—Å—å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
      const ClientRowItem = ({ client, onClick, isSubItem = false }) => (
        <div onClick={() => onClick(client)} className={`relative p-4 cursor-pointer transition-all active:bg-blue-50 border-b border-gray-100 ${isSubItem ? 'bg-gray-50 pl-6 border-l-4 border-l-transparent hover:border-l-blue-400' : 'bg-white'}`}>
          <div className="pr-8 flex flex-col">
            {isSubItem && (<div className="text-[10px] text-gray-400 uppercase tracking-widest font-bold mb-1 flex items-center"><span className="w-2 h-px bg-gray-300 mr-2"></span> –§–ò–õ–ò–ê–õ</div>)}
            <div className={`font-bold text-gray-800 leading-snug ${isSubItem ? 'text-base text-blue-900' : 'text-lg'}`}>{isSubItem && client.branch ? client.branch : client.clientName}</div>
            <div className={`text-sm mt-1 flex flex-wrap items-center gap-2 ${isSubItem ? 'text-gray-800' : 'text-gray-500'}`}>
              {isSubItem ? (<span className="flex items-center"><MapPin size={12} className="text-red-500 mr-1" /> <span className="font-bold text-gray-600">{client.district}</span></span>) : (<span>{client.region}, {client.district}</span>)}
              {client.inn && <span className="text-[10px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded border border-gray-200 font-mono">–ò–ù–ù: {client.inn}</span>}
            </div>
          </div>
          {client.lat ? (
            <div className="absolute top-1/2 -translate-y-1/2 right-4 text-green-500 bg-green-50 rounded-full p-1">
              {client.isLocked ? <Lock size={18} /> : <CheckCircle size={18} />}
            </div>
          ) : (
            <div className="absolute top-1/2 -translate-y-1/2 right-4 text-gray-300">
              <ChevronDown size={20} className="-rotate-90" />
            </div>
          )}
        </div>
      );

      const ClientGroup = ({ name, clients, onSelect }) => {
        const [isOpen, setIsOpen] = useState(false);
        const hasDone = clients.some(c => c.lat);
        return (
          <div className="bg-white border-b border-gray-100 mb-1 last:mb-0">
            <div onClick={() => setIsOpen(!isOpen)} className="p-4 flex flex-between items-center cursor-pointer active:bg-gray-50 flex justify-between">
              <div><div className="font-bold text-gray-900 text-lg">{name}</div><div className="text-xs text-gray-500 mt-0.5 font-medium flex items-center">–§–∏–ª–∏–∞–ª–æ–≤: {clients.length}</div></div>
              <div className="flex items-center space-x-2">
                {hasDone && <span className="bg-green-100 text-green-700 text-[10px] px-2 py-1 rounded-full font-bold">–ï—Å—Ç—å –≥–æ—Ç–æ–≤—ã–µ</span>}
                <div className={`text-gray-400 bg-gray-100 rounded-full p-1 transition-transform duration-200 ${isOpen ? 'rotate-180 bg-blue-100 text-blue-500' : ''}`}>
                  <ChevronDown size={18} />
                </div>
              </div>
            </div>
            {isOpen && <div className="border-t border-gray-100 bg-gray-50 animate-slide-down">{clients.map(client => <ClientRowItem key={client.rowIndex} client={client} onClick={onSelect} isSubItem={true} />)}</div>}
          </div>
        );
      };

      // 5. Platform Diagnostic (–æ—Å—Ç–∞–ª—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
      const PlatformDiagnostic = ({ platformInfo, debugInfo, onManualLogin }) => {
        return (
          <div className="flex flex-col items-center justify-center min-h-screen p-6 bg-gradient-to-br from-red-50 to-orange-50 text-center fade-in">
            <div className="w-24 h-24 bg-red-100 rounded-full flex items-center justify-center mb-6 shadow-lg">
              <AlertTriangle className="w-12 h-12 text-red-600" />
            </div>
            
            <h2 className="text-3xl font-bold mb-4 text-red-800">–û—à–∏–±–∫–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã</h2>
            <p className="text-gray-700 mb-6 text-lg leading-relaxed max-w-md">
              –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ <span className="font-bold text-blue-600">Telegram –±–æ—Ç–∞</span>, –∞ –Ω–µ –∫–∞–∫ –æ–±—ã—á–Ω–∞—è –≤–µ–±-—Å—Ç—Ä–∞–Ω–∏—Ü–∞.
            </p>
            
            <div className="bg-white rounded-xl shadow-lg p-6 max-w-md w-full mb-6">
              <h3 className="font-bold text-gray-800 mb-3 flex items-center gap-2">
                <Smartphone className="w-5 h-5" />
                –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ
              </h3>
              
              <div className="text-left space-y-2 text-sm">
                <div className="flex justify-between">
                  <span className="text-gray-600">–¢–∏–ø –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã:</span>
                  <span className={`font-bold ${platformInfo.type !== 'unknown' ? 'text-green-600' : 'text-red-600'}`}>
                    {platformInfo.type}
                  </span>
                </div>
                <div className="flex justify-between">
                  <span className="text-gray-600">–í–µ—Ä—Å–∏—è:</span>
                  <span className="font-mono text-gray-800">{platformInfo.version}</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-gray-600">–í–∞–ª–∏–¥–Ω—ã–π WebApp:</span>
                  <span className={`font-bold ${platformInfo.isValidWebApp ? 'text-green-600' : 'text-red-600'}`}>
                    {platformInfo.isValidWebApp ? '–î–∞' : '–ù–µ—Ç'}
                  </span>
                </div>
                <div className="flex justify-between">
                  <span className="text-gray-600">–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</span>
                  <span className={`font-bold ${platformInfo.hasUserData ? 'text-green-600' : 'text-red-600'}`}>
                    {platformInfo.hasUserData ? '–ï—Å—Ç—å' : '–ù–µ—Ç'}
                  </span>
                </div>
              </div>
            </div>

            <div className="bg-blue-50 rounded-xl p-6 max-w-md w-full mb-6 border border-blue-200">
              <h3 className="font-bold text-blue-800 mb-3 flex items-center gap-2">
                <Settings className="w-5 h-5" />
                –ö–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å
              </h3>
              
              <div className="text-left space-y-3 text-sm text-blue-700">
                <div className="flex items-start gap-3">
                  <div className="w-6 h-6 bg-blue-500 text-white rounded-full flex items-center justify-center text-xs font-bold mt-0.5">1</div>
                  <div>
                    <div className="font-semibold">–û—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç–∞ –≤ Telegram</div>
                    <div className="text-xs opacity-80">–ù–∞–π–¥–∏—Ç–µ –≤–∞—à–µ–≥–æ –±–æ—Ç–∞ –≤ —Å–ø–∏—Å–∫–µ —á–∞—Ç–æ–≤</div>
                  </div>
                </div>
                
                <div className="flex items-start gap-3">
                  <div className="w-6 h-6 bg-blue-500 text-white rounded-full flex items-center justify-center text-xs font-bold mt-0.5">2</div>
                  <div>
                    <div className="font-semibold">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–ó–∞–ø—É—Å—Ç–∏—Ç—å" –∏–ª–∏ "Start"</div>
                    <div className="text-xs opacity-80">–≠—Ç–æ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç WebApp</div>
                  </div>
                </div>
                
                <div className="flex items-start gap-3">
                  <div className="w-6 h-6 bg-blue-500 text-white rounded-full flex items-center justify-center text-xs font-bold mt-0.5">3</div>
                  <div>
                    <div className="font-semibold">–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–∑ –±–æ—Ç–∞</div>
                    <div className="text-xs opacity-80">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É –≤–Ω—É—Ç—Ä–∏ —á–∞—Ç–∞</div>
                  </div>
                </div>
              </div>
            </div>

            <div className="bg-yellow-50 rounded-xl p-4 max-w-md w-full mb-6 border border-yellow-200">
              <div className="text-sm text-yellow-800">
                <strong>‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ:</strong> –†—É—á–Ω–æ–π –≤–≤–æ–¥ –≤–æ–∑–º–æ–∂–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Ç—Ä–µ–±—É–µ—Ç –∑–Ω–∞–Ω–∏—è –≤–∞—à–µ–≥–æ Telegram ID.
              </div>
            </div>

            <button 
              onClick={onManualLogin}
              className="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition-all active:scale-95 flex items-center gap-2"
            >
              <UserIcon className="w-5 h-5" />
              –†—É—á–Ω–æ–π –≤–≤–æ–¥ (–¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
            </button>
            
            {debugInfo && (
              <button 
                onClick={() => window.dispatchEvent(new CustomEvent('toggleDebug'))}
                className="mt-4 text-xs text-gray-500 hover:text-gray-700 underline"
              >
                –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
              </button>
            )}
          </div>
        );
      };

      // =======================================================
      // MAIN APP COMPONENT (–∏–∑–º–µ–Ω–µ–Ω–∞ —Ç–æ–ª—å–∫–æ –ª–æ–≥–∏–∫–∞ API –≤—ã–∑–æ–≤–æ–≤)
      // =======================================================
      function App() {
        const [loading, setLoading] = useState(true);
        const [authorized, setAuthorized] = useState(false);
        const [user, setUser] = useState(null);
        const [clients, setClients] = useState([]);
        const [activeTab, setActiveTab] = useState('todo');
        const [selectedRegion, setSelectedRegion] = useState("");
        const [selectedDistrict, setSelectedDistrict] = useState("");
        const [searchText, setSearchText] = useState("");
        const [selectedClient, setSelectedClient] = useState(null);
        const [isSubmitting, setIsSubmitting] = useState(false);
        const [submitStatus, setSubmitStatus] = useState(null);
        
        // Geo State
        const [anchorCoords, setAnchorCoords] = useState(null);
        const [markerCoords, setMarkerCoords] = useState(null);
        const [userPos, setUserPos] = useState(null);
        const [isGpsLoading, setIsGpsLoading] = useState(false);

        // Auth & Misc
        const [manualIdInput, setManualIdInput] = useState("");
        const [debugInfo, setDebugInfo] = useState("");
        const [rememberMe, setRememberMe] = useState(true);
        const [deviceLocked, setDeviceLocked] = useState(false);
        const [telegramIdStatus, setTelegramIdStatus] = useState("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...");
        const [telegramDebugInfo, setTelegramDebugInfo] = useState("");
        const [showDebugInfo, setShowDebugInfo] = useState(false);
        const [platformInfo, setPlatformInfo] = useState(null);
        const [showManualLogin, setShowManualLogin] = useState(false);

        // Modals
        const [showContactsModal, setShowContactsModal] = useState(false);
        const [showStockModal, setShowStockModal] = useState(false);
        const [userGroupBrands, setUserGroupBrands] = useState([]);
        const [lastStockData, setLastStockData] = useState(null);

        useEffect(() => {
          if (window.Telegram?.WebApp) {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
            try {
              window.Telegram.WebApp.enableClosingConfirmation();
              window.Telegram.WebApp.MainButton.hide();
            } catch (e) { }
            if (window.Telegram.WebApp.LocationManager) {
              window.Telegram.WebApp.LocationManager.init(() => { });
            }
          }
          
          // –°–ª—É—à–∞—Ç–µ–ª—å –¥–ª—è –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è –æ—Ç–ª–∞–¥–∫–∏
          const handleToggleDebug = () => {
            setShowDebugInfo(!showDebugInfo);
          };
          
          window.addEventListener('toggleDebug', handleToggleDebug);
          
          initApp();
          
          return () => {
            window.removeEventListener('toggleDebug', handleToggleDebug);
          };
        }, []);

        // Real-time location watching (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
        useEffect(() => {
          let watchId = null;
          if (selectedClient) {
            setAnchorCoords(null);
            setMarkerCoords(null);
            setUserPos(null);

            const lat = parseCoord(selectedClient.lat);
            const lng = parseCoord(selectedClient.lng);

            if (lat !== null && lng !== null) {
              setMarkerCoords({ lat, lng });
              if (navigator.geolocation) {
                getNativeLocation((c) => { if (c) setUserPos(c); });
                watchId = navigator.geolocation.watchPosition(
                  (pos) => { setUserPos({ lat: pos.coords.latitude, lng: pos.coords.longitude }); },
                  (err) => console.warn(err),
                  { enableHighAccuracy: true, maximumAge: 2000, timeout: 20000 }
                );
              }
            } else {
              refreshLocation();
            }
          }
          return () => {
            if (watchId !== null) navigator.geolocation.clearWatch(watchId);
          };
        }, [selectedClient]);

        // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø (–∏–∑–º–µ–Ω–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ API)
        const initApp = async () => {
          setLoading(true);
          setTelegramIdStatus("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp...");
          
          console.log("=== –ù–ê–ß–ê–õ–û –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò ===");
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π ID
          const savedId = localStorage.getItem('geo_bot_user_id');
          if (savedId) {
            console.log('–ù–∞–π–¥–µ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π ID:', savedId);
            setTelegramIdStatus("–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π ID");
            checkServer(savedId, true);
            return;
          }

          // –î–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä—É–µ–º –ø–ª–∞—Ç—Ñ–æ—Ä–º—É –ü–ï–†–í–´–ú –î–ï–õ–û–ú
          const platform = detectPlatform();
          setPlatformInfo(platform);
          console.log("üì± –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ:", platform);
          
          if (!platform.isValidWebApp) {
            console.log("‚ùå –ù–ï –Ø–í–õ–Ø–ï–¢–°–Ø Telegram WebApp!");
            setTelegramIdStatus("–ù–µ–≤–µ—Ä–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞");
            setDebugInfo("–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞");
            setLoading(false);
            return;
          }

          // –ü–æ–ª—É—á–∞–µ–º Telegram –¥–∞–Ω–Ω—ã–µ
          setTelegramIdStatus("–ü–æ–∏—Å–∫ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...");
          const telegramData = await getTelegramData();
          
          if (telegramData.success) {
            console.log("=== TELEGRAM –î–ê–ù–ù–´–ï –ü–û–õ–£–ß–ï–ù–´ ===");
            console.log("–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", telegramData.data);
            
            setTelegramIdStatus("Telegram ID –ø–æ–ª—É—á–µ–Ω: " + telegramData.data.id);
            setTelegramDebugInfo(telegramData.debug.join('\n'));
            
            checkServer(String(telegramData.data.id), true);
          } else {
            console.log("=== –û–®–ò–ë–ö–ê –ü–û–õ–£–ß–ï–ù–ò–Ø TELEGRAM –î–ê–ù–ù–´–• ===");
            console.log("–û—à–∏–±–∫–∞:", telegramData.error);
            console.log("–õ–æ–≥ –æ—Ç–ª–∞–¥–∫–∏:", telegramData.debug);
            
            setTelegramIdStatus("Telegram –¥–∞–Ω–Ω—ã–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã");
            setTelegramDebugInfo(telegramData.debug.join('\n'));
            setDebugInfo(telegramData.solution || telegramData.error);
            
            setLoading(false);
          }
        };

        // –ü–†–û–í–ï–†–ö–ê –°–ï–†–í–ï–†–ê (–∏–∑–º–µ–Ω–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ API)
        const checkServer = async (idToCheck, shouldSave = true) => {
          setLoading(true);
          const deviceId = getDeviceId();
          
          console.log("=== –û–¢–ü–†–ê–í–ö–ê –ù–ê –°–ï–†–í–ï–† ===");
          console.log("ID –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:", idToCheck);
          console.log("Device ID:", deviceId);
          
          try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤ —Ä–µ–∂–∏–º–µ –ª–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
            if (isDevelopmentMode()) {
              console.log("üîß –†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –º–æ–∫ –¥–∞–Ω–Ω—ã–µ");
              setTimeout(() => {
                if (String(idToCheck) === '112233') {
                  setAuthorized(true);
                  setUser(MOCK_USER);
                  setClients(MOCK_CLIENTS);
                  setDeviceLocked(false);
                  setTelegramIdStatus("–£—Å–ø–µ—à–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (—Ä–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)");
                  setLoading(false);
                } else {
                  setAuthorized(false);
                  setDebugInfo("–î–æ—Å—Ç—É–ø –∑–∞–∫—Ä—ã—Ç: –í–∞—à ID –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ (—Ä–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏).");
                  setLoading(false);
                }
              }, 800);
              return;
            }

            // –†–µ–∞–ª—å–Ω—ã–π API –≤—ã–∑–æ–≤
            const data = await googleService.getAppData(idToCheck, deviceId);
            console.log("=== –û–¢–í–ï–¢ –°–ï–†–í–ï–†–ê ===");
            console.log("–î–∞–Ω–Ω—ã–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:", data);
            
            if (data.authorized) {
              if (shouldSave) {
                localStorage.setItem('geo_bot_user_id', idToCheck);
              } else {
                localStorage.removeItem('geo_bot_user_id');
              }

              setAuthorized(true);
              setUser(data.user);
              setClients(data.clients || []);
              setDeviceLocked(false);
              setTelegramIdStatus("–£—Å–ø–µ—à–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è");

              await googleService.logSessionEvent(data.user, "–í–•–û–î –í –°–ò–°–¢–ï–ú–£");

              if (data.stockHeaders && data.stockHeaders.length > 0) {
                setUserGroupBrands(data.stockHeaders);
              } else if (data.user && data.user.group) {
                const brands = await googleService.getGroupBrands(data.user.group);
                setUserGroupBrands(brands);
              }
            } else {
              console.log("=== –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –û–¢–ö–õ–û–ù–ï–ù–ê ===");
              setAuthorized(false);
              
              if (data.errorType === 'DEVICE_MISMATCH') {
                setDeviceLocked(true);
                setDebugInfo(data.error || "–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ.");
              } else {
                 setDebugInfo("–î–æ—Å—Ç—É–ø –∑–∞–∫—Ä—ã—Ç: –í–∞—à ID –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ.");
              }

              localStorage.removeItem('geo_bot_user_id');
            }
          } catch (e) {
            console.log("=== –û–®–ò–ë–ö–ê –°–ï–¢–ò ===");
            console.log("–û—à–∏–±–∫–∞:", e.message);
            setDebugInfo("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: " + e.message);
          } finally {
            setLoading(false);
          }
        };

        // –û–°–¢–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò (–∏–∑–º–µ–Ω–µ–Ω–∞ —Ç–æ–ª—å–∫–æ –ª–æ–≥–∏–∫–∞ API)
        const handleManualLogin = () => {
          setShowManualLogin(true);
        };

        const handleManualLoginSubmit = () => {
          if (manualIdInput) {
            setShowManualLogin(false);
            checkServer(manualIdInput, rememberMe);
          }
        };

        const handleLogout = () => {
          if (confirm('–í—ã–π—Ç–∏?')) {
            if (user) googleService.logSessionEvent(user, "–í–´–•–û–î –ò–ó –°–ò–°–¢–ï–ú–´");
            
            localStorage.removeItem('geo_bot_user_id');
            setAuthorized(false);
            setUser(null);
            setClients([]);
            setManualIdInput("");
            setRememberMe(true);
          }
        };

        const refreshLocation = () => {
          setIsGpsLoading(true);
          getNativeLocation((coords) => {
            if (coords) {
              setAnchorCoords(coords);
              setUserPos(coords);
              if (selectedClient && !selectedClient.isLocked) {
                setMarkerCoords(coords);
              }
            } else {
              alert("‚ùå –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ GPS.");
              setAnchorCoords(null);
              if (!selectedClient?.lat) setMarkerCoords(null);
            }
            setIsGpsLoading(false);
          });
        };

        const handleSendLocation = () => {
          if (!selectedClient || selectedClient.isLocked) return;
          if (!markerCoords || !markerCoords.lat || !anchorCoords) {
            alert("‚õîÔ∏è –û–®–ò–ë–ö–ê: –ù–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω–æ–π –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏!\n\n–í—ã –¥–æ–ª–∂–Ω—ã –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –Ω–∞ —Ç–æ—á–∫–µ –∏ –Ω–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É '–ü—Ä–∏—Ü–µ–ª' –Ω–∞ –∫–∞—Ä—Ç–µ.");
            return;
          }

          setIsSubmitting(true);
          googleService.updateLocation(selectedClient.rowIndex, markerCoords.lat, markerCoords.lng, user ? user.name : "")
            .then(res => {
              if (res === "SUCCESS") {
                setSubmitStatus('success');
                setClients(prev => prev.map(c => c.rowIndex === selectedClient.rowIndex ? { ...c, lat: markerCoords.lat, lng: markerCoords.lng, updatedBy: user ? user.name : "–Ø", updatedAt: new Date().toISOString(), isLocked: true } : c));
              } else {
                alert("–û—à–∏–±–∫–∞: " + res);
              }
            })
            .catch(() => alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏"))
            .finally(() => setIsSubmitting(false));
        };

        const openStockModalHandler = () => {
          if (!selectedClient || !user) return;
          setShowStockModal(true);
          setLastStockData(null);
          
          googleService.getLastStockData(user, selectedClient)
            .then(setLastStockData)
            .catch(console.error);
        };

        const handleSaveContacts = (contacts, comment, callback) => {
          if (!selectedClient) return;
          googleService.saveContacts(selectedClient.rowIndex, contacts, comment, user ? user.name : "Unknown")
            .then(res => {
              if (res === "SUCCESS") {
                const updated = { ...selectedClient, contacts, comment };
                setClients(prev => prev.map(c => c.rowIndex === selectedClient.rowIndex ? updated : c));
                setSelectedClient(updated);
                callback();
              } else {
                alert("–û—à–∏–±–∫–∞: " + res);
                callback();
              }
            })
            .catch(() => { alert("Network Error"); callback(); });
        };

        const handleSaveStock = (stockItems, comment, callback) => {
          if (!selectedClient || !user) return;
          googleService.saveStockData(stockItems, comment, user, selectedClient)
            .then(res => {
              if (res === "SUCCESS") {
                alert("–û—Å—Ç–∞—Ç–∫–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!");
              } else {
                alert("–û—à–∏–±–∫–∞: " + res);
              }
              callback();
            })
            .catch(() => { alert("Network Error"); callback(); });
        };

        // –û–°–¢–ê–õ–¨–ù–´–ï –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
        const uniqueRegions = useMemo(() => Array.from(new Set(clients.map(c => c.region).filter(Boolean))).sort(), [clients]);
        const uniqueDistricts = useMemo(() => (!selectedRegion ? [] : Array.from(new Set(clients.filter(c => c.region === selectedRegion).map(c => c.district).filter(Boolean))).sort()), [clients, selectedRegion]);

        const filteredClients = useMemo(() => {
          return clients.filter(client => {
            if (selectedRegion && client.region !== selectedRegion) return false;
            if (selectedDistrict && client.district !== selectedDistrict) return false;
            if (searchText) {
              const lowText = searchText.toLowerCase();
              return String(client.clientName).toLowerCase().includes(lowText) ||
                String(client.branch || "").toLowerCase().includes(lowText) ||
                String(client.inn || "").includes(lowText);
            }
            return true;
          });
        }, [clients, selectedRegion, selectedDistrict, searchText]);

        const counts = useMemo(() => ({
          todo: filteredClients.filter(c => !(c.lat && c.lng)).length,
          done: filteredClients.filter(c => !!(c.lat && c.lng)).length
        }), [filteredClients]);

        const groupedClients = useMemo(() => {
          const displayList = filteredClients.filter(client => {
            const isDone = !!(client.lat && client.lng);
            if (activeTab === 'todo' && isDone) return false;
            if (activeTab === 'done' && !isDone) return false;
            return true;
          });
          const groups = {};
          displayList.forEach(client => {
            const name = client.clientName;
            if (!groups[name]) groups[name] = [];
            groups[name].push(client);
          });
          return groups;
        }, [filteredClients, activeTab]);

        const groupKeys = Object.keys(groupedClients);

        // =======================================================
        // RENDER LOGIC (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
        // =======================================================

        // –≠–ö–†–ê–ù –ó–ê–ì–†–£–ó–ö–ò
        if (loading) return (
          <div className="flex flex-col items-center justify-center min-h-screen bg-gray-50">
            <Loader2 className="w-8 h-8 text-blue-600 animate-spin mb-4" />
            <p className="text-gray-500 font-medium animate-pulse mb-2">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            <p className="text-xs text-gray-400 mb-2">{telegramIdStatus}</p>
            
            {platformInfo && (
              <div className="mt-4 p-3 bg-gray-100 rounded-lg text-xs max-w-sm">
                <div className="font-bold mb-1">–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞: {platformInfo.type}</div>
                <div>–í–µ—Ä—Å–∏—è: {platformInfo.version}</div>
                <div className={platformInfo.isValidWebApp ? 'text-green-600' : 'text-red-600'}>
                  WebApp: {platformInfo.isValidWebApp ? '–í–∞–ª–∏–¥–Ω—ã–π' : '–ù–µ–≤–∞–ª–∏–¥–Ω—ã–π'}
                </div>
              </div>
            )}
          </div>
        );

        // –≠–ö–†–ê–ù –î–ò–ê–ì–ù–û–°–¢–ò–ö–ò –ü–õ–ê–¢–§–û–†–ú–´
        if (platformInfo && !platformInfo.isValidWebApp) {
          return (
            <PlatformDiagnostic 
              platformInfo={platformInfo}
              debugInfo={telegramDebugInfo}
              onManualLogin={handleManualLogin}
            />
          );
        }

        // –≠–ö–†–ê–ù –†–£–ß–ù–û–ì–û –í–•–û–î–ê
        if (showManualLogin) {
          return (
            <div className="flex flex-col items-center justify-center min-h-screen p-6 bg-white text-center fade-in">
              <h2 className="text-2xl font-bold mb-2">–†—É—á–Ω–æ–π –≤—Ö–æ–¥</h2>
              <p className="text-gray-500 mb-6 text-sm">
                –í–≤–µ–¥–∏—Ç–µ –≤–∞—à Telegram ID –≤—Ä—É—á–Ω—É—é (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏).
              </p>
              
              <div className="w-full max-w-xs space-y-4">
                <input
                  type="number"
                  className="border-2 border-gray-200 p-4 rounded-xl w-full text-center text-lg outline-none focus:border-blue-500"
                  placeholder="–í–≤–µ–¥–∏—Ç–µ Telegram ID"
                  value={manualIdInput}
                  onChange={e => setManualIdInput(e.target.value)}
                />
                <button 
                  onClick={handleManualLoginSubmit}
                  className="bg-blue-600 text-white py-4 w-full rounded-xl font-bold text-lg shadow-lg active:scale-95"
                >
                  –í–æ–π—Ç–∏
                </button>
                <div className="flex items-center justify-center gap-2 cursor-pointer mt-2" onClick={() => setRememberMe(!rememberMe)}>
                  <div className={`w-5 h-5 rounded border flex items-center justify-center transition-colors ${rememberMe ? 'bg-blue-600 border-blue-600' : 'bg-white border-gray-300'}`}>
                    {rememberMe && <CheckCircle className="w-3 h-3 text-white" />}
                  </div>
                  <span className="text-gray-600 text-sm select-none">–ó–∞–ø–æ–º–Ω–∏—Ç—å –º–µ–Ω—è</span>
                </div>
                <button 
                  onClick={() => setShowManualLogin(false)}
                  className="text-gray-500 text-sm underline"
                >
                  –û—Ç–º–µ–Ω–∞
                </button>
              </div>
            </div>
          );
        }

        if (!authorized) {
          if (deviceLocked) {
             return (
              <div className="flex flex-col items-center justify-center min-h-screen p-6 bg-red-50 text-center fade-in">
                <div className="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mb-6 shadow-sm">
                   <ShieldAlert className="w-10 h-10 text-red-600" />
                </div>
                <h2 className="text-2xl font-bold mb-2 text-red-800">–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω</h2>
                <p className="text-gray-700 mb-6 text-sm leading-relaxed max-w-xs mx-auto">
                   –í—ã —É–∂–µ –≤–æ—à–ª–∏ —Å –¥—Ä—É–≥–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞. –ò–∑ —Å–æ–æ–±—Ä–∞–∂–µ–Ω–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –≤—Ö–æ–¥ —Ä–∞–∑—Ä–µ—à–µ–Ω —Ç–æ–ª—å–∫–æ —Å –æ–¥–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞.
                </p>
                <div className="bg-white p-4 rounded-xl shadow-sm border border-red-100 max-w-xs w-full mb-6">
                    <p className="text-xs text-gray-500 font-medium">–î–ª—è —Å–±—Ä–æ—Å–∞ –ø—Ä–∏–≤—è–∑–∫–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.</p>
                </div>
                <button onClick={() => { setDeviceLocked(false); setManualIdInput(""); setDebugInfo(""); }} className="text-red-500 text-sm font-bold hover:bg-red-100 px-4 py-2 rounded-lg transition-colors">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–π ID</button>
              </div>
             );
          }

          return (
            <div className="flex flex-col items-center justify-center min-h-screen p-6 bg-white text-center fade-in">
              <h2 className="text-2xl font-bold mb-2">–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h2>
              <p className="text-gray-500 mb-6 text-sm">–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å, –∫–æ—Ç–æ—Ä—ã–π –≤—ã –ø–æ–ª—É—á–∏–ª–∏ –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.</p>
              <div className="w-full max-w-xs space-y-4">
                <input
                  type="number"
                  className="border-2 border-gray-200 p-4 rounded-xl w-full text-center text-lg outline-none focus:border-blue-500"
                  placeholder="ID (—á–∏—Å–ª–æ)"
                  value={manualIdInput}
                  onChange={e => setManualIdInput(e.target.value)}
                />
                <button onClick={handleManualLoginSubmit} className="bg-blue-600 text-white py-4 w-full rounded-xl font-bold text-lg shadow-lg active:scale-95">–í–æ–π—Ç–∏</button>
                <div className="flex items-center justify-center gap-2 cursor-pointer mt-2" onClick={() => setRememberMe(!rememberMe)}>
                  <div className={`w-5 h-5 rounded border flex items-center justify-center transition-colors ${rememberMe ? 'bg-blue-600 border-blue-600' : 'bg-white border-gray-300'}`}>
                    {rememberMe && <CheckCircle className="w-3 h-3 text-white" />}
                  </div>
                  <span className="text-gray-600 text-sm select-none">–ó–∞–ø–æ–º–Ω–∏—Ç—å –º–µ–Ω—è</span>
                </div>
              </div>
              {debugInfo && <div className="mt-4 text-xs text-red-500 bg-red-50 border border-red-100 p-3 rounded-lg font-medium">{debugInfo}</div>}
            </div>
          );
        }

        if (submitStatus === 'success' && selectedClient) {
          return (
            <div className="flex flex-col items-center justify-center min-h-screen p-6 bg-green-50 text-center fade-in">
              <div className="bg-white p-8 rounded-2xl shadow w-full max-w-sm">
                <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                  <CheckCircle className="w-8 h-8 text-green-600" />
                </div>
                <h2 className="text-xl font-bold mb-2">–û—Ç–º–µ—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!</h2>
                <div className="text-gray-500 mb-4">{selectedClient.clientName}</div>
                <button onClick={() => setShowContactsModal(true)} className="w-full bg-blue-50 text-blue-600 py-3 rounded-xl font-bold mb-2">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥–∞–≤—Ü–æ–≤</button>
                <button onClick={() => { setSubmitStatus(null); setSelectedClient(null); setSearchText(""); }} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold">–î–∞–ª—å—à–µ –∫ —Å–ø–∏—Å–∫—É</button>
              </div>
              <ContactsModal 
                isOpen={showContactsModal} 
                onClose={() => setShowContactsModal(false)} 
                initialContacts={selectedClient.contacts} 
                initialComment={selectedClient.comment} 
                onSave={handleSaveContacts} 
                isLocked={selectedClient.isLocked} 
              />
            </div>
          );
        }

        if (selectedClient) {
          const mapIsSaved = !!(selectedClient.lat && selectedClient.lng);
          let dist = null;
          if (mapIsSaved && userPos) {
            const cLat = parseCoord(selectedClient.lat);
            const cLng = parseCoord(selectedClient.lng);
            if (cLat && cLng) dist = getDistanceFromLatLonInKm(userPos.lat, userPos.lng, cLat, cLng);
          }
          
          const isTestUser = user?.id === '112233';
          const canEditStock = isTestUser || (mapIsSaved && userPos && dist !== null && dist <= 0.03);
          const canSubmit = !!markerCoords && !!markerCoords.lat && !!markerCoords.lng && !!anchorCoords;

          return (
            <div className="h-screen flex flex-col bg-gray-50 fade-in overflow-hidden">
              <div className="bg-white shadow z-10 p-4 flex-shrink-0 max-h-[50vh] overflow-y-auto">
                <div className="flex justify-between items-start mb-3">
                  <button onClick={() => setSelectedClient(null)} className="text-gray-500 flex items-center font-medium text-sm">
                    <ChevronDown className="w-4 h-4 mr-1 rotate-90" /> –ö —Å–ø–∏—Å–∫—É
                  </button>
                  <div className="flex gap-2">
                    <button
                      onClick={openStockModalHandler}
                      disabled={!canEditStock}
                      className={`flex items-center gap-1 px-3 py-1.5 rounded-lg text-xs font-bold transition-colors ${canEditStock ? 'bg-purple-100 text-purple-700 hover:bg-purple-200' : 'bg-gray-100 text-gray-400 cursor-not-allowed opacity-60'}`}
                      title={!canEditStock ? `–°–ª–∏—à–∫–æ–º –¥–∞–ª–µ–∫–æ. –ù—É–∂–Ω–æ < 30–º` : "–í–Ω–µ—Å—Ç–∏ –æ—Å—Ç–∞—Ç–∫–∏"}
                    >
                      <Package size={14} /> <span>–û—Å—Ç–∞—Ç–∫–∏</span>
                    </button>
                    <button onClick={() => setShowContactsModal(true)} className="flex items-center gap-1 text-blue-600 bg-blue-50 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-blue-100">
                      <Pencil size={14} /> <span>–ö–æ–Ω—Ç–∞–∫—Ç—ã</span> ({selectedClient.contacts ? selectedClient.contacts.length : 0})
                    </button>
                  </div>
                </div>

                <div className="mb-3">
                  {selectedClient.branch ? (
                    <>
                      <div className="text-gray-500 text-sm font-medium">{selectedClient.clientName}</div>
                      <div className="text-xl font-bold text-blue-800 leading-tight">{selectedClient.branch}</div>
                      <div className="mt-1 flex items-center text-sm font-bold text-gray-600"><MapPin size={14} className="mr-1" /> {selectedClient.district}</div>
                    </>
                  ) : (
                    <>
                      <h1 className="text-xl font-bold leading-tight mb-1 text-gray-900">{selectedClient.clientName}</h1>
                      <div className="text-gray-600 text-sm mb-2 flex items-center">{selectedClient.region}, {selectedClient.district}</div>
                    </>
                  )}
                </div>
                
                {selectedClient.inn && <div className="mb-3 text-xs text-gray-500 font-mono bg-gray-50 p-1.5 rounded inline-block">–ò–ù–ù: {selectedClient.inn}</div>}

                {selectedClient.lat && (
                  <div className="space-y-3 mb-4">
                    <div className={`px-3 py-2 rounded-lg border flex items-start gap-2 ${selectedClient.isLocked ? 'bg-gray-100 border-gray-200' : 'bg-yellow-50 border-yellow-200'}`}>
                      <div className="mt-0.5">{selectedClient.isLocked ? <Lock size={18} /> : <Pencil size={18} />}</div>
                      <div className="text-xs text-gray-600">
                        <span className={`font-bold ${selectedClient.isLocked ? 'text-gray-700' : 'text-yellow-700'}`}>{selectedClient.isLocked ? '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ' : '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ'}</span><br />
                        {selectedClient.updatedBy && <span>–ö–µ–º: <b>{selectedClient.updatedBy}</b><br /></span>}
                        {selectedClient.updatedAt && <span>–ö–æ–≥–¥–∞: {formatDate(selectedClient.updatedAt)}</span>}
                      </div>
                    </div>
                    <div className="bg-blue-50 p-3 rounded-lg border border-blue-100">
                      <div className="flex justify-between items-center mb-2">
                        <h3 className="text-sm font-bold text-blue-800">–ú–∞—Ä—à—Ä—É—Ç</h3>
                        {dist !== null && <span className="text-xs font-bold text-gray-600 bg-white px-2 py-0.5 rounded shadow-sm">~ {dist.toFixed(1)} –∫–º</span>}
                      </div>
                      <div className="flex gap-2">
                        <a href={`https://yandex.ru/maps/?rtext=~${selectedClient.lat},${selectedClient.lng}&rtt=auto`} target="_blank" className="flex-1 bg-yellow-400 text-black text-xs font-bold py-2 rounded flex items-center justify-center gap-1"><ExternalLink size={12}/> Yandex</a>
                        <a href={`https://www.google.com/maps/dir/?api=1&destination=${selectedClient.lat},${selectedClient.lng}`} target="_blank" className="flex-1 bg-white border border-gray-300 text-gray-700 text-xs font-bold py-2 rounded flex items-center justify-center gap-1"><ExternalLink size={12}/> Google</a>
                      </div>
                    </div>
                  </div>
                )}

                <div className="mt-1">
                  {isSubmitting ? (
                    <div className="w-full bg-gray-100 text-gray-500 font-bold py-3 rounded-xl flex justify-center items-center gap-2">
                      <Loader2 className="animate-spin" /> GPS...
                    </div>
                  ) : (
                    selectedClient.isLocked ? (
                      <div className="text-center text-xs text-gray-400 p-2 bg-gray-50 rounded-lg">–ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –∑–∞–ø—Ä–µ—â–µ–Ω–æ.<br />–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –¥–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏.</div>
                    ) : (
                      <button
                        onClick={handleSendLocation}
                        disabled={!canSubmit}
                        className={`w-full font-bold py-3 rounded-xl shadow-md flex justify-center items-center gap-2 transition-transform ${canSubmit ? 'bg-blue-600 text-white active:scale-95' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}`}
                      >
                        {!canSubmit ? (
                          <span>üì° –û–∂–∏–¥–∞–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç (–ù–∞–∂–º–∏—Ç–µ –ü—Ä–∏—Ü–µ–ª)...</span>
                        ) : (
                          <span>üìç {selectedClient.lat ? "–û–ë–ù–û–í–ò–¢–¨ –õ–û–ö–ê–¶–ò–Æ" : "–û–¢–ü–†–ê–í–ò–¢–¨ –õ–û–ö–ê–¶–ò–Æ"}</span>
                        )}
                      </button>
                    )
                  )}
                </div>
              </div>

              <div className="flex-1 relative bg-gray-200">
                <MapViewer
                  anchorLat={anchorCoords?.lat}
                  anchorLng={anchorCoords?.lng}
                  markerLat={markerCoords?.lat}
                  markerLng={markerCoords?.lng}
                  isLocked={selectedClient.isLocked}
                  onLocate={refreshLocation}
                  onMarkerChange={(lat, lng) => setMarkerCoords({ lat, lng })}
                  isGpsLoading={isGpsLoading}
                />
              </div>
              
              <ContactsModal 
                isOpen={showContactsModal} 
                onClose={() => setShowContactsModal(false)} 
                initialContacts={selectedClient.contacts} 
                initialComment={selectedClient.comment} 
                onSave={handleSaveContacts} 
                isLocked={selectedClient.isLocked} 
              />
              <StockModal
                isOpen={showStockModal}
                onClose={() => setShowStockModal(false)}
                onSave={handleSaveStock}
                brands={userGroupBrands}
                lastStockData={lastStockData}
                clientName={selectedClient.branch || selectedClient.clientName}
              />
            </div>
          );
        }

        return (
          <div className="h-screen flex flex-col fade-in bg-white">
            <div className="bg-white px-4 py-3 shadow-sm border-b border-gray-100 sticky top-0 z-20 flex-shrink-0">
              <div className="flex justify-between items-center mb-3">
                <div className="flex items-center gap-3">
                  <div className="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-blue-600">
                    <Navigation className="w-6 h-6" />
                  </div>
                  <div>
                    <h1 className="font-bold text-lg leading-none text-gray-800">GeoTap</h1>
                    <p className="text-xs text-gray-500 font-medium mt-1">{user ? user.name : "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"}</p>
                  </div>
                </div>
                <div className="flex items-center gap-2">
                  <button onClick={() => checkServer(user?.id || "", true)} className="w-8 h-8 rounded-lg bg-blue-50 text-blue-600 flex items-center justify-center hover:bg-blue-100 active:scale-95 transition-all" title="–û–±–Ω–æ–≤–∏—Ç—å">
                    <RefreshCw className="w-5 h-5" />
                  </button>
                  <button onClick={handleLogout} className="text-xs text-red-500 bg-red-50 px-3 py-1.5 rounded-lg font-medium hover:bg-red-100 transition-colors h-8 flex items-center gap-1">
                    <LogOut size={12} /> –í—ã–π—Ç–∏
                  </button>
                </div>
              </div>

              <div className="grid grid-cols-2 gap-2 bg-gray-100 p-1 rounded-lg mb-2">
                <button onClick={() => setActiveTab('todo')} className={`py-1.5 text-sm font-bold rounded-md transition-all ${activeTab === 'todo' ? 'bg-white shadow text-blue-600' : 'text-gray-500'}`}>–í —Ä–∞–±–æ—Ç–µ ({counts.todo})</button>
                <button onClick={() => setActiveTab('done')} className={`py-1.5 text-sm font-bold rounded-md transition-all ${activeTab === 'done' ? 'bg-white shadow text-green-600' : 'text-gray-500'}`}>–ì–æ—Ç–æ–≤—ã–µ ({counts.done})</button>
              </div>

              <div className="flex space-x-2 mb-2">
                <div className="relative w-1/2">
                  <select value={selectedRegion} onChange={(e) => { setSelectedRegion(e.target.value); setSelectedDistrict(""); }} className="block w-full bg-gray-100 border-none rounded-lg p-2 text-sm font-medium outline-none appearance-none pr-6">
                    <option value="">–í—Å–µ —Ä–µ–≥–∏–æ–Ω—ã</option>
                    {uniqueRegions.map(r => <option key={r} value={r}>{r}</option>)}
                  </select>
                  <ChevronDown className="absolute right-2 top-3 w-4 h-4 text-gray-400 pointer-events-none" />
                </div>
                <div className="relative w-1/2">
                  <select value={selectedDistrict} onChange={(e) => setSelectedDistrict(e.target.value)} disabled={!selectedRegion} className={`block w-full border-none rounded-lg p-2 text-sm font-medium outline-none appearance-none pr-6 ${!selectedRegion ? 'bg-gray-50 text-gray-300' : 'bg-gray-100 text-gray-900'}`}>
                    <option value="">{selectedRegion ? "–í—Å–µ —Ä–∞–π–æ–Ω—ã" : "–†–∞–π–æ–Ω"}</option>
                    {uniqueDistricts.map(d => <option key={d} value={d}>{d}</option>)}
                  </select>
                  <ChevronDown className="absolute right-2 top-3 w-4 h-4 text-gray-400 pointer-events-none" />
                </div>
              </div>

              <div className="relative">
                <input type="text" placeholder="–ü–æ–∏—Å–∫ (–ù–∞–∑–≤–∞–Ω–∏–µ –∏–ª–∏ –ò–ù–ù)..." value={searchText} onChange={e => setSearchText(e.target.value)} className="w-full bg-gray-100 border-none rounded-lg py-2 pl-9 text-sm outline-none" />
                <Search className="w-4 h-4 text-gray-400 absolute left-3 top-2.5" />
              </div>
            </div>

            <div className="flex-1 overflow-y-auto bg-gray-50 pb-8">
              {groupKeys.length === 0 ? <div className="text-center py-10 text-gray-400 text-sm">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç</div> : groupKeys.map(clientName => {
                const group = groupedClients[clientName];
                if (group.length === 1) return <ClientRowItem key={group[0].rowIndex} client={group[0]} onClick={setSelectedClient} />;
                return <ClientGroup key={clientName} name={clientName} clients={group} onSelect={setSelectedClient} />;
              })}
            </div>
          </div>
        );
      }

      const root = createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
